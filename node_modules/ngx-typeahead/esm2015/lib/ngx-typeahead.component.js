import { __decorate } from "tslib";
import { HttpClient } from '@angular/common/http';
import { ChangeDetectorRef, Component, ElementRef, EventEmitter, HostListener, Input, OnDestroy, OnInit, Output, TemplateRef, ViewChild, ViewContainerRef, } from '@angular/core';
import { of, Subject } from 'rxjs';
import { concat, debounceTime, distinctUntilChanged, filter, map, switchMap, tap, } from 'rxjs/operators';
import { Key } from './models';
import { createParamsForQuery, hasCharacters, isEnterKey, isEscapeKey, isIndexActive, resolveApiMethod, resolveNextIndex, toFormControlValue, toJsonpFinalResults, toJsonpSingleResult, validateArrowKeys, validateNonCharKeyCode, resolveItemValue, NO_INDEX, } from './ngx-typeahead.utils';
/*
 using an external template:
 <input [taItemTpl]="itemTpl" >

  <ng-template #itemTpl let-result>
    <strong>MY {{ result.result }}</strong>
  </ng-template>
*/
let NgxTypeAheadComponent = class NgxTypeAheadComponent {
    constructor(element, viewContainer, http, cdr) {
        this.element = element;
        this.viewContainer = viewContainer;
        this.http = http;
        this.cdr = cdr;
        this.showSuggestions = false;
        this.results = [];
        this.taUrl = '';
        this.taParams = {};
        this.taQueryParam = 'q';
        this.taApi = 'jsonp';
        this.taApiMethod = 'get';
        this.taList = [];
        this.taListItemField = [];
        this.taListItemLabel = '';
        this.taDebounce = 300;
        this.taAllowEmpty = false;
        this.taCaseSensitive = false;
        this.taDisplayOnFocus = false;
        this.taSelected = new EventEmitter();
        this.suggestionIndex = 0;
        this.subscriptions = [];
        this.activeResult = '';
        this.searchQuery = '';
        this.selectedItem = {};
        this.resultsAsItems = [];
        this.keydown$ = new Subject();
        this.keyup$ = new Subject();
    }
    handleEsc(event) {
        if (isEscapeKey(event)) {
            this.hideSuggestions();
            event.preventDefault();
        }
        this.keydown$.next(event);
    }
    onkeyup(event) {
        event.preventDefault();
        event.stopPropagation();
        this.keyup$.next(event);
    }
    onClick() {
        if (this.taDisplayOnFocus) {
            this.displaySuggestions();
        }
    }
    ngOnInit() {
        this.filterEnterEvent(this.keydown$);
        this.listenAndSuggest(this.keyup$);
        this.navigateWithArrows(this.keydown$);
        this.renderTemplate();
    }
    ngOnDestroy() {
        this.keydown$.complete();
        this.keyup$.complete();
    }
    renderTemplate() {
        if (!this.suggestionsTplRef) {
            console.error('NO NGXTA Template Found. Requires NG9');
            return;
        }
        this.viewContainer.createEmbeddedView(this.suggestionsTplRef);
        this.cdr.markForCheck();
    }
    listenAndSuggest(obs) {
        obs
            .pipe(
        // tslint:disable-next-line: deprecation
        filter((e) => validateNonCharKeyCode(e.code)), map(toFormControlValue), debounceTime(this.taDebounce), 
        // tslint:disable-next-line: deprecation
        concat(), distinctUntilChanged(), filter((query) => this.taAllowEmpty || hasCharacters(query)), tap((query) => (this.searchQuery = query)), switchMap((query) => this.suggest(query)))
            .subscribe((results) => {
            this.assignResults(results);
            // this.updateIndex(Key.ArrowDown);
            this.displaySuggestions();
        });
    }
    assignResults(results) {
        const labelForDisplay = this.taListItemLabel;
        this.resultsAsItems = results;
        this.results = results.map((item) => labelForDisplay ? item[labelForDisplay] : item);
        this.suggestionIndex = NO_INDEX;
        if (!results || !results.length) {
            this.activeResult = this.searchQuery;
        }
    }
    filterEnterEvent(elementObs) {
        elementObs.pipe(filter(isEnterKey)).subscribe((event) => {
            this.handleSelectSuggestion(this.activeResult);
        });
    }
    navigateWithArrows(elementObs) {
        elementObs
            .pipe(map((e) => e.key), filter((key) => validateArrowKeys(key)))
            .subscribe((key) => {
            this.updateIndex(key);
            this.displaySuggestions();
        });
    }
    updateIndex(keyCode) {
        this.suggestionIndex = resolveNextIndex(this.suggestionIndex, keyCode === Key.ArrowDown, this.results.length);
    }
    displaySuggestions() {
        this.showSuggestions = true;
        this.cdr.markForCheck();
    }
    suggest(query) {
        return this.taList.length
            ? this.createListSource(this.taList, query)
            : this.request(query);
    }
    /**
     * peforms a jsonp/http request to search with query and params
     * @param query the query to search from the remote source
     */
    request(query) {
        const url = this.taUrl;
        const searchConfig = createParamsForQuery(query, this.taQueryParam, this.taParams);
        const options = {
            params: searchConfig,
        };
        const isJsonpApi = this.taApi === 'jsonp';
        return isJsonpApi
            ? this.requestJsonp(url, options, this.taCallbackParamValue)
            : this.requestHttp(url, options);
    }
    requestHttp(url, options) {
        const apiMethod = resolveApiMethod(this.taApiMethod);
        return this.http[apiMethod](url, options);
    }
    requestJsonp(url, options, callback = 'callback') {
        const params = options.params.toString();
        return this.http
            .jsonp(`${url}?${params}`, callback)
            .pipe(map(toJsonpSingleResult), map(toJsonpFinalResults));
    }
    markIsActive(index, result) {
        const isActive = isIndexActive(index, this.suggestionIndex);
        if (isActive) {
            this.activeResult = result;
        }
        return isActive;
    }
    handleSelectionClick(suggestion, index) {
        this.suggestionIndex = index;
        this.handleSelectSuggestion(suggestion);
    }
    handleSelectSuggestion(suggestion) {
        const result = this.resultsAsItems.length
            ? this.resultsAsItems[this.suggestionIndex]
            : suggestion;
        this.hideSuggestions();
        const resolvedResult = this.suggestionIndex === NO_INDEX ? this.searchQuery : result;
        this.taSelected.emit(resolvedResult);
    }
    hideSuggestions() {
        this.showSuggestions = false;
    }
    hasItemTemplate() {
        return this.taItemTpl !== undefined;
    }
    createListSource(list, query) {
        const sanitizedQuery = this.taCaseSensitive ? query : query.toLowerCase();
        const fieldsToExtract = this.taListItemField;
        return of(list.filter((item) => {
            return resolveItemValue(item, fieldsToExtract, this.taCaseSensitive).includes(sanitizedQuery);
        }));
    }
};
NgxTypeAheadComponent.ctorParameters = () => [
    { type: ElementRef },
    { type: ViewContainerRef },
    { type: HttpClient },
    { type: ChangeDetectorRef }
];
__decorate([
    Input()
], NgxTypeAheadComponent.prototype, "taItemTpl", void 0);
__decorate([
    Input()
], NgxTypeAheadComponent.prototype, "taUrl", void 0);
__decorate([
    Input()
], NgxTypeAheadComponent.prototype, "taParams", void 0);
__decorate([
    Input()
], NgxTypeAheadComponent.prototype, "taQueryParam", void 0);
__decorate([
    Input()
], NgxTypeAheadComponent.prototype, "taCallbackParamValue", void 0);
__decorate([
    Input()
], NgxTypeAheadComponent.prototype, "taApi", void 0);
__decorate([
    Input()
], NgxTypeAheadComponent.prototype, "taApiMethod", void 0);
__decorate([
    Input()
], NgxTypeAheadComponent.prototype, "taList", void 0);
__decorate([
    Input()
], NgxTypeAheadComponent.prototype, "taListItemField", void 0);
__decorate([
    Input()
], NgxTypeAheadComponent.prototype, "taListItemLabel", void 0);
__decorate([
    Input()
], NgxTypeAheadComponent.prototype, "taDebounce", void 0);
__decorate([
    Input()
], NgxTypeAheadComponent.prototype, "taAllowEmpty", void 0);
__decorate([
    Input()
], NgxTypeAheadComponent.prototype, "taCaseSensitive", void 0);
__decorate([
    Input()
], NgxTypeAheadComponent.prototype, "taDisplayOnFocus", void 0);
__decorate([
    Output()
], NgxTypeAheadComponent.prototype, "taSelected", void 0);
__decorate([
    ViewChild(TemplateRef, { static: true })
], NgxTypeAheadComponent.prototype, "suggestionsTplRef", void 0);
__decorate([
    HostListener('keydown', ['$event'])
], NgxTypeAheadComponent.prototype, "handleEsc", null);
__decorate([
    HostListener('keyup', ['$event'])
], NgxTypeAheadComponent.prototype, "onkeyup", null);
__decorate([
    HostListener('click')
], NgxTypeAheadComponent.prototype, "onClick", null);
NgxTypeAheadComponent = __decorate([
    Component({
        // tslint:disable-next-line: component-selector
        selector: 'ngx-typeahead, [ngxTypeahead]',
        template: `
    <ng-template #suggestionsTplRef>
      <section class="ta-results list-group" *ngIf="showSuggestions">
        <div class="ta-backdrop" (click)="hideSuggestions()"></div>
        <button
          type="button"
          class="ta-item list-group-item"
          *ngFor="let result of results; let i = index"
          [class.active]="markIsActive(i, result)"
          (click)="handleSelectionClick(result, i)"
        >
          <span *ngIf="!taItemTpl"
            ><i class="fa fa-search"></i> {{ result }}</span
          >
          <ng-template
            [ngTemplateOutlet]="taItemTpl"
            [ngTemplateOutletContext]="{
              $implicit: { result: result, index: i }
            }"
          ></ng-template>
        </button>
      </section>
    </ng-template>
  `,
        styles: [`
      .ta-results {
        position: absolute;
      }
      .ta-backdrop {
        bottom: 0;
        left: 0;
        position: fixed;
        right: 0;
        top: 0;
        z-index: 1;
      }
      .ta-item {
        position: relative;
        z-index: 2;
        display: block;
      }
    `]
    })
], NgxTypeAheadComponent);
export { NgxTypeAheadComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmd4LXR5cGVhaGVhZC5jb21wb25lbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9uZ3gtdHlwZWFoZWFkLyIsInNvdXJjZXMiOlsibGliL25neC10eXBlYWhlYWQuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFDbEQsT0FBTyxFQUNMLGlCQUFpQixFQUNqQixTQUFTLEVBQ1QsVUFBVSxFQUNWLFlBQVksRUFDWixZQUFZLEVBQ1osS0FBSyxFQUNMLFNBQVMsRUFDVCxNQUFNLEVBQ04sTUFBTSxFQUNOLFdBQVcsRUFDWCxTQUFTLEVBQ1QsZ0JBQWdCLEdBQ2pCLE1BQU0sZUFBZSxDQUFDO0FBQ3ZCLE9BQU8sRUFBRSxFQUFFLEVBQWMsT0FBTyxFQUFnQixNQUFNLE1BQU0sQ0FBQztBQUM3RCxPQUFPLEVBQ0wsTUFBTSxFQUNOLFlBQVksRUFDWixvQkFBb0IsRUFDcEIsTUFBTSxFQUNOLEdBQUcsRUFDSCxTQUFTLEVBQ1QsR0FBRyxHQUNKLE1BQU0sZ0JBQWdCLENBQUM7QUFDeEIsT0FBTyxFQUFFLEdBQUcsRUFBRSxNQUFNLFVBQVUsQ0FBQztBQUMvQixPQUFPLEVBQ0wsb0JBQW9CLEVBQ3BCLGFBQWEsRUFDYixVQUFVLEVBQ1YsV0FBVyxFQUNYLGFBQWEsRUFDYixnQkFBZ0IsRUFDaEIsZ0JBQWdCLEVBQ2hCLGtCQUFrQixFQUNsQixtQkFBbUIsRUFDbkIsbUJBQW1CLEVBQ25CLGlCQUFpQixFQUNqQixzQkFBc0IsRUFDdEIsZ0JBQWdCLEVBQ2hCLFFBQVEsR0FDVCxNQUFNLHVCQUF1QixDQUFDO0FBRS9COzs7Ozs7O0VBT0U7QUFpREYsSUFBYSxxQkFBcUIsR0FBbEMsTUFBYSxxQkFBcUI7SUFnRGhDLFlBQ1UsT0FBbUIsRUFDbkIsYUFBK0IsRUFDL0IsSUFBZ0IsRUFDaEIsR0FBc0I7UUFIdEIsWUFBTyxHQUFQLE9BQU8sQ0FBWTtRQUNuQixrQkFBYSxHQUFi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QUFDLFFBQVEsQ0FBQyxDQUFDO29EQUtqQztBQUdEO0lBREMsWUFBWSxDQUFDLE9BQU8sQ0FBQztvREFLckI7QUE1RVUscUJBQXFCO0lBaERqQyxTQUFTLENBQUM7UUFDVCwrQ0FBK0M7UUFDL0MsUUFBUSxFQUFFLCtCQUErQjtRQXFCekMsUUFBUSxFQUFFOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztHQXVCVDtpQkExQ0M7Ozs7Ozs7Ozs7Ozs7Ozs7O0tBaUJDO0tBMEJKLENBQUM7R0FDVyxxQkFBcUIsQ0FxUGpDO1NBclBZLHFCQUFxQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEh0dHBDbGllbnQgfSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XG5pbXBvcnQge1xuICBDaGFuZ2VEZXRlY3RvclJlZixcbiAgQ29tcG9uZW50LFxuICBFbGVtZW50UmVmLFxuICBFdmVudEVtaXR0ZXIsXG4gIEhvc3RMaXN0ZW5lcixcbiAgSW5wdXQsXG4gIE9uRGVzdHJveSxcbiAgT25Jbml0LFxuICBPdXRwdXQsXG4gIFRlbXBsYXRlUmVmLFxuICBWaWV3Q2hpbGQsXG4gIFZpZXdDb250YWluZXJSZWYsXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgb2YsIE9ic2VydmFibGUsIFN1YmplY3QsIFN1YnNjcmlwdGlvbiB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHtcbiAgY29uY2F0LFxuICBkZWJvdW5jZVRpbWUsXG4gIGRpc3RpbmN0VW50aWxDaGFuZ2VkLFxuICBmaWx0ZXIsXG4gIG1hcCxcbiAgc3dpdGNoTWFwLFxuICB0YXAsXG59IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IEtleSB9IGZyb20gJy4vbW9kZWxzJztcbmltcG9ydCB7XG4gIGNyZWF0ZVBhcmFtc0ZvclF1ZXJ5LFxuICBoYXNDaGFyYWN0ZXJzLFxuICBpc0VudGVyS2V5LFxuICBpc0VzY2FwZUtleSxcbiAgaXNJbmRleEFjdGl2ZSxcbiAgcmVzb2x2ZUFwaU1ldGhvZCxcbiAgcmVzb2x2ZU5leHRJbmRleCxcbiAgdG9Gb3JtQ29udHJvbFZhbHVlLFxuICB0b0pzb25wRmluYWxSZXN1bHRzLFxuICB0b0pzb25wU2luZ2xlUmVzdWx0LFxuICB2YWxpZGF0ZUFycm93S2V5cyxcbiAgdmFsaWRhdGVOb25DaGFyS2V5Q29kZSxcbiAgcmVzb2x2ZUl0ZW1WYWx1ZSxcbiAgTk9fSU5ERVgsXG59IGZyb20gJy4vbmd4LXR5cGVhaGVhZC51dGlscyc7XG5cbi8qXG4gdXNpbmcgYW4gZXh0ZXJuYWwgdGVtcGxhdGU6XG4gPGlucHV0IFt0YUl0ZW1UcGxdPVwiaXRlbVRwbFwiID5cblxuICA8bmctdGVtcGxhdGUgI2l0ZW1UcGwgbGV0LXJlc3VsdD5cbiAgICA8c3Ryb25nPk1ZIHt7IHJlc3VsdC5yZXN1bHQgfX08L3N0cm9uZz5cbiAgPC9uZy10ZW1wbGF0ZT5cbiovXG5AQ29tcG9uZW50KHtcbiAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOiBjb21wb25lbnQtc2VsZWN0b3JcbiAgc2VsZWN0b3I6ICduZ3gtdHlwZWFoZWFkLCBbbmd4VHlwZWFoZWFkXScsXG4gIHN0eWxlczogW1xuICAgIGBcbiAgICAgIC50YS1yZXN1bHRzIHtcbiAgICAgICAgcG9zaXRpb246IGFic29sdXRlO1xuICAgICAgfVxuICAgICAgLnRhLWJhY2tkcm9wIHtcbiAgICAgICAgYm90dG9tOiAwO1xuICAgICAgICBsZWZ0OiAwO1xuICAgICAgICBwb3NpdGlvbjogZml4ZWQ7XG4gICAgICAgIHJpZ2h0OiAwO1xuICAgICAgICB0b3A6IDA7XG4gICAgICAgIHotaW5kZXg6IDE7XG4gICAgICB9XG4gICAgICAudGEtaXRlbSB7XG4gICAgICAgIHBvc2l0aW9uOiByZWxhdGl2ZTtcbiAgICAgICAgei1pbmRleDogMjtcbiAgICAgICAgZGlzcGxheTogYmxvY2s7XG4gICAgICB9XG4gICAgYCxcbiAgXSxcbiAgdGVtcGxhdGU6IGBcbiAgICA8bmctdGVtcGxhdGUgI3N1Z2dlc3Rpb25zVHBsUmVmPlxuICAgICAgPHNlY3Rpb24gY2xhc3M9XCJ0YS1yZXN1bHRzIGxpc3QtZ3JvdXBcIiAqbmdJZj1cInNob3dTdWdnZXN0aW9uc1wiPlxuICAgICAgICA8ZGl2IGNsYXNzPVwidGEtYmFja2Ryb3BcIiAoY2xpY2spPVwiaGlkZVN1Z2dlc3Rpb25zKClcIj48L2Rpdj5cbiAgICAgICAgPGJ1dHRvblxuICAgICAgICAgIHR5cGU9XCJidXR0b25cIlxuICAgICAgICAgIGNsYXNzPVwidGEtaXRlbSBsaXN0LWdyb3VwLWl0ZW1cIlxuICAgICAgICAgICpuZ0Zvcj1cImxldCByZXN1bHQgb2YgcmVzdWx0czsgbGV0IGkgPSBpbmRleFwiXG4gICAgICAgICAgW2NsYXNzLmFjdGl2ZV09XCJtYXJrSXNBY3RpdmUoaSwgcmVzdWx0KVwiXG4gICAgICAgICAgKGNsaWNrKT1cImhhbmRsZVNlbGVjdGlvbkNsaWNrKHJlc3VsdCwgaSlcIlxuICAgICAgICA+XG4gICAgICAgICAgPHNwYW4gKm5nSWY9XCIhdGFJdGVtVHBsXCJcbiAgICAgICAgICAgID48aSBjbGFzcz1cImZhIGZhLXNlYXJjaFwiPjwvaT4ge3sgcmVzdWx0IH19PC9zcGFuXG4gICAgICAgICAgPlxuICAgICAgICAgIDxuZy10ZW1wbGF0ZVxuICAgICAgICAgICAgW25nVGVtcGxhdGVPdXRsZXRdPVwidGFJdGVtVHBsXCJcbiAgICAgICAgICAgIFtuZ1RlbXBsYXRlT3V0bGV0Q29udGV4dF09XCJ7XG4gICAgICAgICAgICAgICRpbXBsaWNpdDogeyByZXN1bHQ6IHJlc3VsdCwgaW5kZXg6IGkgfVxuICAgICAgICAgICAgfVwiXG4gICAgICAgICAgPjwvbmctdGVtcGxhdGU+XG4gICAgICAgIDwvYnV0dG9uPlxuICAgICAgPC9zZWN0aW9uPlxuICAgIDwvbmctdGVtcGxhdGU+XG4gIGAsXG59KVxuZXhwb3J0IGNsYXNzIE5neFR5cGVBaGVhZENvbXBvbmVudCBpbXBsZW1lbnRzIE9uSW5pdCwgT25EZXN0cm95IHtcbiAgc2hvd1N1Z2dlc3Rpb25zID0gZmFsc2U7XG4gIHJlc3VsdHM6IHN0cmluZ1tdID0gW107XG5cbiAgQElucHV0KClcbiAgdGFJdGVtVHBsITogVGVtcGxhdGVSZWY8YW55PjtcbiAgQElucHV0KClcbiAgdGFVcmwgPSAnJztcbiAgQElucHV0KClcbiAgdGFQYXJhbXMgPSB7fTtcbiAgQElucHV0KClcbiAgdGFRdWVyeVBhcmFtID0gJ3EnO1xuICBASW5wdXQoKVxuICB0YUNhbGxiYWNrUGFyYW1WYWx1ZTtcbiAgQElucHV0KClcbiAgdGFBcGkgPSAnanNvbnAnO1xuICBASW5wdXQoKVxuICB0YUFwaU1ldGhvZCA9ICdnZXQnO1xuICBASW5wdXQoKVxuICB0YUxpc3QgPSBbXTtcbiAgQElucHV0KClcbiAgdGFMaXN0SXRlbUZpZWxkID0gW107XG4gIEBJbnB1dCgpXG4gIHRhTGlzdEl0ZW1MYWJlbCA9ICcnO1xuICBASW5wdXQoKVxuICB0YURlYm91bmNlID0gMzAwO1xuICBASW5wdXQoKVxuICB0YUFsbG93RW1wdHkgPSBmYWxzZTtcbiAgQElucHV0KClcbiAgdGFDYXNlU2Vuc2l0aXZlID0gZmFsc2U7XG4gIEBJbnB1dCgpXG4gIHRhRGlzcGxheU9uRm9jdXMgPSBmYWxzZTtcblxuICBAT3V0cHV0KClcbiAgdGFTZWxlY3RlZCA9IG5ldyBFdmVudEVtaXR0ZXI8c3RyaW5nIHwgYW55PigpO1xuXG4gIEBWaWV3Q2hpbGQoVGVtcGxhdGVSZWYsIHsgc3RhdGljOiB0cnVlIH0pXG4gIHN1Z2dlc3Rpb25zVHBsUmVmOiBUZW1wbGF0ZVJlZjxhbnk+O1xuXG4gIHByaXZhdGUgc3VnZ2VzdGlvbkluZGV4ID0gMDtcbiAgcHJpdmF0ZSBzdWJzY3JpcHRpb25zOiBTdWJzY3JpcHRpb25bXSA9IFtdO1xuICBwcml2YXRlIGFjdGl2ZVJlc3VsdCA9ICcnO1xuICBwcml2YXRlIHNlYXJjaFF1ZXJ5ID0gJyc7XG4gIHByaXZhdGUgc2VsZWN0ZWRJdGVtOiBhbnkgPSB7fTtcbiAgcHJpdmF0ZSByZXN1bHRzQXNJdGVtczogYW55W10gPSBbXTtcbiAgcHJpdmF0ZSBrZXlkb3duJCA9IG5ldyBTdWJqZWN0PEtleWJvYXJkRXZlbnQ+KCk7XG4gIHByaXZhdGUga2V5dXAkID0gbmV3IFN1YmplY3Q8S2V5Ym9hcmRFdmVudD4oKTtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIGVsZW1lbnQ6IEVsZW1lbnRSZWYsXG4gICAgcHJpdmF0ZSB2aWV3Q29udGFpbmVyOiBWaWV3Q29udGFpbmVyUmVmLFxuICAgIHByaXZhdGUgaHR0cDogSHR0cENsaWVudCxcbiAgICBwcml2YXRlIGNkcjogQ2hhbmdlRGV0ZWN0b3JSZWZcbiAgKSB7fVxuXG4gIEBIb3N0TGlzdGVuZXIoJ2tleWRvd24nLCBbJyRldmVudCddKVxuICBoYW5kbGVFc2MoZXZlbnQ6IEtleWJvYXJkRXZlbnQpIHtcbiAgICBpZiAoaXNFc2NhcGVLZXkoZXZlbnQpKSB7XG4gICAgICB0aGlzLmhpZGVTdWdnZXN0aW9ucygpO1xuICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcbiAgICB9XG4gICAgdGhpcy5rZXlkb3duJC5uZXh0KGV2ZW50KTtcbiAgfVxuXG4gIEBIb3N0TGlzdGVuZXIoJ2tleXVwJywgWyckZXZlbnQnXSlcbiAgb25rZXl1cChldmVudDogS2V5Ym9hcmRFdmVudCkge1xuICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgdGhpcy5rZXl1cCQubmV4dChldmVudCk7XG4gIH1cblxuICBASG9zdExpc3RlbmVyKCdjbGljaycpXG4gIG9uQ2xpY2soKSB7XG4gICAgaWYgKHRoaXMudGFEaXNwbGF5T25Gb2N1cykge1xuICAgICAgdGhpcy5kaXNwbGF5U3VnZ2VzdGlvbnMoKTtcbiAgICB9XG4gIH1cblxuICBuZ09uSW5pdCgpIHtcbiAgICB0aGlzLmZpbHRlckVudGVyRXZlbnQodGhpcy5rZXlkb3duJCk7XG4gICAgdGhpcy5saXN0ZW5BbmRTdWdnZXN0KHRoaXMua2V5dXAkKTtcbiAgICB0aGlzLm5hdmlnYXRlV2l0aEFycm93cyh0aGlzLmtleWRvd24kKTtcbiAgICB0aGlzLnJlbmRlclRlbXBsYXRlKCk7XG4gIH1cblxuICBuZ09uRGVzdHJveSgpIHtcbiAgICB0aGlzLmtleWRvd24kLmNvbXBsZXRlKCk7XG4gICAgdGhpcy5rZXl1cCQuY29tcGxldGUoKTtcbiAgfVxuXG4gIHJlbmRlclRlbXBsYXRlKCkge1xuICAgIGlmICghdGhpcy5zdWdnZXN0aW9uc1RwbFJlZikge1xuICAgICAgY29uc29sZS5lcnJvcignTk8gTkdYVEEgVGVtcGxhdGUgRm91bmQuIFJlcXVpcmVzIE5HOScpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0aGlzLnZpZXdDb250YWluZXIuY3JlYXRlRW1iZWRkZWRWaWV3KHRoaXMuc3VnZ2VzdGlvbnNUcGxSZWYpO1xuICAgIHRoaXMuY2RyLm1hcmtGb3JDaGVjaygpO1xuICB9XG5cbiAgbGlzdGVuQW5kU3VnZ2VzdChvYnM6IFN1YmplY3Q8S2V5Ym9hcmRFdmVudD4pIHtcbiAgICBvYnNcbiAgICAgIC5waXBlKFxuICAgICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6IGRlcHJlY2F0aW9uXG4gICAgICAgIGZpbHRlcigoZTogS2V5Ym9hcmRFdmVudCkgPT4gdmFsaWRhdGVOb25DaGFyS2V5Q29kZShlLmNvZGUpKSxcbiAgICAgICAgbWFwKHRvRm9ybUNvbnRyb2xWYWx1ZSksXG4gICAgICAgIGRlYm91bmNlVGltZSh0aGlzLnRhRGVib3VuY2UpLFxuICAgICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6IGRlcHJlY2F0aW9uXG4gICAgICAgIGNvbmNhdCgpLFxuICAgICAgICBkaXN0aW5jdFVudGlsQ2hhbmdlZCgpLFxuICAgICAgICBmaWx0ZXIoKHF1ZXJ5OiBzdHJpbmcpID0+IHRoaXMudGFBbGxvd0VtcHR5IHx8IGhhc0NoYXJhY3RlcnMocXVlcnkpKSxcbiAgICAgICAgdGFwKChxdWVyeTogc3RyaW5nKSA9PiAodGhpcy5zZWFyY2hRdWVyeSA9IHF1ZXJ5KSksXG4gICAgICAgIHN3aXRjaE1hcCgocXVlcnk6IHN0cmluZykgPT4gdGhpcy5zdWdnZXN0KHF1ZXJ5KSlcbiAgICAgIClcbiAgICAgIC5zdWJzY3JpYmUoKHJlc3VsdHM6IHN0cmluZ1tdIHwgYW55KSA9PiB7XG4gICAgICAgIHRoaXMuYXNzaWduUmVzdWx0cyhyZXN1bHRzKTtcbiAgICAgICAgLy8gdGhpcy51cGRhdGVJbmRleChLZXkuQXJyb3dEb3duKTtcbiAgICAgICAgdGhpcy5kaXNwbGF5U3VnZ2VzdGlvbnMoKTtcbiAgICAgIH0pO1xuICB9XG5cbiAgYXNzaWduUmVzdWx0cyhyZXN1bHRzOiBhbnlbXSkge1xuICAgIGNvbnN0IGxhYmVsRm9yRGlzcGxheSA9IHRoaXMudGFMaXN0SXRlbUxhYmVsO1xuICAgIHRoaXMucmVzdWx0c0FzSXRlbXMgPSByZXN1bHRzO1xuICAgIHRoaXMucmVzdWx0cyA9IHJlc3VsdHMubWFwKChpdGVtOiBzdHJpbmcgfCBhbnkpID0+XG4gICAgICBsYWJlbEZvckRpc3BsYXkgPyBpdGVtW2xhYmVsRm9yRGlzcGxheV0gOiBpdGVtXG4gICAgKTtcbiAgICB0aGlzLnN1Z2dlc3Rpb25JbmRleCA9IE5PX0lOREVYO1xuICAgIGlmICghcmVzdWx0cyB8fCAhcmVzdWx0cy5sZW5ndGgpIHtcbiAgICAgIHRoaXMuYWN0aXZlUmVzdWx0ID0gdGhpcy5zZWFyY2hRdWVyeTtcbiAgICB9XG4gIH1cblxuICBmaWx0ZXJFbnRlckV2ZW50KGVsZW1lbnRPYnM6IFN1YmplY3Q8S2V5Ym9hcmRFdmVudD4pIHtcbiAgICBlbGVtZW50T2JzLnBpcGUoZmlsdGVyKGlzRW50ZXJLZXkpKS5zdWJzY3JpYmUoKGV2ZW50OiBLZXlib2FyZEV2ZW50KSA9PiB7XG4gICAgICB0aGlzLmhhbmRsZVNlbGVjdFN1Z2dlc3Rpb24odGhpcy5hY3RpdmVSZXN1bHQpO1xuICAgIH0pO1xuICB9XG5cbiAgbmF2aWdhdGVXaXRoQXJyb3dzKGVsZW1lbnRPYnM6IFN1YmplY3Q8S2V5Ym9hcmRFdmVudD4pIHtcbiAgICBlbGVtZW50T2JzXG4gICAgICAucGlwZShcbiAgICAgICAgbWFwKChlOiBhbnkpID0+IGUua2V5KSxcbiAgICAgICAgZmlsdGVyKChrZXk6IEtleSkgPT4gdmFsaWRhdGVBcnJvd0tleXMoa2V5KSlcbiAgICAgIClcbiAgICAgIC5zdWJzY3JpYmUoKGtleTogS2V5KSA9PiB7XG4gICAgICAgIHRoaXMudXBkYXRlSW5kZXgoa2V5KTtcbiAgICAgICAgdGhpcy5kaXNwbGF5U3VnZ2VzdGlvbnMoKTtcbiAgICAgIH0pO1xuICB9XG5cbiAgdXBkYXRlSW5kZXgoa2V5Q29kZTogc3RyaW5nKSB7XG4gICAgdGhpcy5zdWdnZXN0aW9uSW5kZXggPSByZXNvbHZlTmV4dEluZGV4KFxuICAgICAgdGhpcy5zdWdnZXN0aW9uSW5kZXgsXG4gICAgICBrZXlDb2RlID09PSBLZXkuQXJyb3dEb3duLFxuICAgICAgdGhpcy5yZXN1bHRzLmxlbmd0aFxuICAgICk7XG4gIH1cblxuICBkaXNwbGF5U3VnZ2VzdGlvbnMoKSB7XG4gICAgdGhpcy5zaG93U3VnZ2VzdGlvbnMgPSB0cnVlO1xuICAgIHRoaXMuY2RyLm1hcmtGb3JDaGVjaygpO1xuICB9XG5cbiAgc3VnZ2VzdChxdWVyeTogc3RyaW5nKSB7XG4gICAgcmV0dXJuIHRoaXMudGFMaXN0Lmxlbmd0aFxuICAgICAgPyB0aGlzLmNyZWF0ZUxpc3RTb3VyY2UodGhpcy50YUxpc3QsIHF1ZXJ5KVxuICAgICAgOiB0aGlzLnJlcXVlc3QocXVlcnkpO1xuICB9XG5cbiAgLyoqXG4gICAqIHBlZm9ybXMgYSBqc29ucC9odHRwIHJlcXVlc3QgdG8gc2VhcmNoIHdpdGggcXVlcnkgYW5kIHBhcmFtc1xuICAgKiBAcGFyYW0gcXVlcnkgdGhlIHF1ZXJ5IHRvIHNlYXJjaCBmcm9tIHRoZSByZW1vdGUgc291cmNlXG4gICAqL1xuICByZXF1ZXN0KHF1ZXJ5OiBzdHJpbmcpIHtcbiAgICBjb25zdCB1cmwgPSB0aGlzLnRhVXJsO1xuICAgIGNvbnN0IHNlYXJjaENvbmZpZyA9IGNyZWF0ZVBhcmFtc0ZvclF1ZXJ5KFxuICAgICAgcXVlcnksXG4gICAgICB0aGlzLnRhUXVlcnlQYXJhbSxcbiAgICAgIHRoaXMudGFQYXJhbXNcbiAgICApO1xuICAgIGNvbnN0IG9wdGlvbnMgPSB7XG4gICAgICBwYXJhbXM6IHNlYXJjaENvbmZpZyxcbiAgICB9O1xuICAgIGNvbnN0IGlzSnNvbnBBcGkgPSB0aGlzLnRhQXBpID09PSAnanNvbnAnO1xuICAgIHJldHVybiBpc0pzb25wQXBpXG4gICAgICA/IHRoaXMucmVxdWVzdEpzb25wKHVybCwgb3B0aW9ucywgdGhpcy50YUNhbGxiYWNrUGFyYW1WYWx1ZSlcbiAgICAgIDogdGhpcy5yZXF1ZXN0SHR0cCh1cmwsIG9wdGlvbnMpO1xuICB9XG5cbiAgcmVxdWVzdEh0dHAodXJsOiBzdHJpbmcsIG9wdGlvbnMpIHtcbiAgICBjb25zdCBhcGlNZXRob2QgPSByZXNvbHZlQXBpTWV0aG9kKHRoaXMudGFBcGlNZXRob2QpO1xuICAgIHJldHVybiB0aGlzLmh0dHBbYXBpTWV0aG9kXSh1cmwsIG9wdGlvbnMpO1xuICB9XG5cbiAgcmVxdWVzdEpzb25wKHVybCwgb3B0aW9ucywgY2FsbGJhY2sgPSAnY2FsbGJhY2snKSB7XG4gICAgY29uc3QgcGFyYW1zID0gb3B0aW9ucy5wYXJhbXMudG9TdHJpbmcoKTtcbiAgICByZXR1cm4gdGhpcy5odHRwXG4gICAgICAuanNvbnAoYCR7dXJsfT8ke3BhcmFtc31gLCBjYWxsYmFjaylcbiAgICAgIC5waXBlKG1hcCh0b0pzb25wU2luZ2xlUmVzdWx0KSwgbWFwKHRvSnNvbnBGaW5hbFJlc3VsdHMpKTtcbiAgfVxuXG4gIG1hcmtJc0FjdGl2ZShpbmRleDogbnVtYmVyLCByZXN1bHQ6IHN0cmluZykge1xuICAgIGNvbnN0IGlzQWN0aXZlID0gaXNJbmRleEFjdGl2ZShpbmRleCwgdGhpcy5zdWdnZXN0aW9uSW5kZXgpO1xuICAgIGlmIChpc0FjdGl2ZSkge1xuICAgICAgdGhpcy5hY3RpdmVSZXN1bHQgPSByZXN1bHQ7XG4gICAgfVxuICAgIHJldHVybiBpc0FjdGl2ZTtcbiAgfVxuXG4gIGhhbmRsZVNlbGVjdGlvbkNsaWNrKHN1Z2dlc3Rpb246IHN0cmluZywgaW5kZXg6IG51bWJlcikge1xuICAgIHRoaXMuc3VnZ2VzdGlvbkluZGV4ID0gaW5kZXg7XG4gICAgdGhpcy5oYW5kbGVTZWxlY3RTdWdnZXN0aW9uKHN1Z2dlc3Rpb24pO1xuICB9XG5cbiAgaGFuZGxlU2VsZWN0U3VnZ2VzdGlvbihzdWdnZXN0aW9uOiBzdHJpbmcpIHtcbiAgICBjb25zdCByZXN1bHQgPSB0aGlzLnJlc3VsdHNBc0l0ZW1zLmxlbmd0aFxuICAgICAgPyB0aGlzLnJlc3VsdHNBc0l0ZW1zW3RoaXMuc3VnZ2VzdGlvbkluZGV4XVxuICAgICAgOiBzdWdnZXN0aW9uO1xuICAgIHRoaXMuaGlkZVN1Z2dlc3Rpb25zKCk7XG4gICAgY29uc3QgcmVzb2x2ZWRSZXN1bHQgPVxuICAgICAgdGhpcy5zdWdnZXN0aW9uSW5kZXggPT09IE5PX0lOREVYID8gdGhpcy5zZWFyY2hRdWVyeSA6IHJlc3VsdDtcbiAgICB0aGlzLnRhU2VsZWN0ZWQuZW1pdChyZXNvbHZlZFJlc3VsdCk7XG4gIH1cblxuICBoaWRlU3VnZ2VzdGlvbnMoKSB7XG4gICAgdGhpcy5zaG93U3VnZ2VzdGlvbnMgPSBmYWxzZTtcbiAgfVxuXG4gIGhhc0l0ZW1UZW1wbGF0ZSgpIHtcbiAgICByZXR1cm4gdGhpcy50YUl0ZW1UcGwgIT09IHVuZGVmaW5lZDtcbiAgfVxuXG4gIGNyZWF0ZUxpc3RTb3VyY2UobGlzdDogYW55W10sIHF1ZXJ5OiBzdHJpbmcpOiBPYnNlcnZhYmxlPHN0cmluZ1tdPiB7XG4gICAgY29uc3Qgc2FuaXRpemVkUXVlcnkgPSB0aGlzLnRhQ2FzZVNlbnNpdGl2ZSA/IHF1ZXJ5IDogcXVlcnkudG9Mb3dlckNhc2UoKTtcbiAgICBjb25zdCBmaWVsZHNUb0V4dHJhY3QgPSB0aGlzLnRhTGlzdEl0ZW1GaWVsZDtcbiAgICByZXR1cm4gb2YoXG4gICAgICBsaXN0LmZpbHRlcigoaXRlbTogc3RyaW5nIHwgYW55KSA9PiB7XG4gICAgICAgIHJldHVybiByZXNvbHZlSXRlbVZhbHVlKFxuICAgICAgICAgIGl0ZW0sXG4gICAgICAgICAgZmllbGRzVG9FeHRyYWN0LFxuICAgICAgICAgIHRoaXMudGFDYXNlU2Vuc2l0aXZlXG4gICAgICAgICkuaW5jbHVkZXMoc2FuaXRpemVkUXVlcnkpO1xuICAgICAgfSlcbiAgICApO1xuICB9XG59XG4iXX0=